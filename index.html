<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <title>Mô phỏng Windows 10 - Chia sẻ tệp/thư mục (File Explorer)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root{
      --win-blue:#0078d7;
      --win-border:#dcdcdc;
      --win-bg:#f3f3f3;
      --win-text:#222;
      --nav-bg:#ffffff;
      --content-bg:#ffffff;
    }
    body{ background: var(--win-bg); color: var(--win-text); }
    .explorer{
      border:1px solid var(--win-border);
      border-radius:8px; overflow:hidden;
      box-shadow:0 6px 24px rgba(0,0,0,.08);
      background: #fff;
    }
    .explorer-header{
      background: linear-gradient(180deg,#ffffff,#f7f7f7);
      border-bottom:1px solid var(--win-border);
      padding:.5rem .75rem;
    }
    .ribbon .btn{ border: none; }
    .address-bar{
      border:1px solid var(--win-border);
      border-radius:4px; background:#fff;
      padding:.25rem .5rem; display:flex; gap:.5rem; align-items:center;
      min-height: 36px;
    }
    .crumb{ display:inline-flex; align-items:center; gap:.25rem; }
    .crumb .bi{ opacity:.65; }
    .sidebar{
      background: var(--nav-bg);
      border-right:1px solid var(--win-border);
      min-height: 60vh;
    }
    .nav-item-fx{
      padding:.5rem .75rem; display:flex; align-items:center; gap:.5rem; border-radius:6px; cursor:pointer;
    }
    .nav-item-fx.active, .nav-item-fx:hover{
      background:#e9f3ff; color:#0b5ed7;
    }
    .content{
      background: var(--content-bg); min-height: 60vh;
    }
    .tile{
      border:1px solid var(--win-border);
      border-radius:8px; padding:.75rem;
      display:flex; align-items:center; gap:.75rem;
      cursor:pointer; background:#fff;
      transition: transform .08s ease;
      position: relative;
    }
    .tile:active{ transform: scale(.99);}
    .tile.selected{ outline:2px solid #0d6efd; outline-offset:-2px; }
    .tile .overlay-share{
      position:absolute; bottom:6px; right:8px;
      font-size: .95rem; opacity:.85; color:#0d6efd;
    }
    .grid{ display:grid; gap:.75rem; grid-template-columns: repeat(auto-fill,minmax(230px,1fr)); }
    /* context menu */
    .ctx-menu{
      position:fixed; z-index: 9999; display:none;
      min-width: 200px; background:#fff; border:1px solid var(--win-border); border-radius:8px;
      box-shadow: 0 10px 30px rgba(0,0,0,.15);
      overflow: hidden;
    }
    .ctx-item{ padding:.6rem .8rem; display:flex; gap:.6rem; align-items:center; cursor:pointer; }
    .ctx-item:hover{ background:#f2f6ff; }
    .mobile-toolbar{
      position: sticky; top:0; z-index: 5; background:#fff; border-bottom:1px solid var(--win-border);
    }
    .badge-step{ font-weight:600; }
    /* Windows-like tabs look (props modal) */
    .nav-tabs .nav-link{ border:1px solid var(--win-border)!important; margin-right:.25rem; }
    .nav-tabs .nav-link.active{ background:#fff!important; border-bottom-color:#fff!important; }
    .tab-content{ border:1px solid var(--win-border); border-top:none; padding:1rem; border-radius:0 0 .5rem .5rem; }
    .share-list table{ font-size: .95rem; }
    .folder-icon{ font-size:2rem; color:#fbbc05; }
    .computer-icon{ font-size:2rem; color:#6c757d; }
    .network-cable{ font-size:1.1rem; }
    /* Helper on phones */
    @media (max-width: 576px){
      .address-bar { font-size:.9rem; }
      .tile{ padding:.65rem; }
    }
  </style>
</head>
<body>
<div class="container py-3">
  <div class="d-flex align-items-center mb-3">
    <i class="bi bi-windows fs-3 text-primary me-2"></i>
    <h1 class="h4 m-0">File Explorer – Mô phỏng chia sẻ thư mục (Windows 10)</h1>
  </div>

  <div class="row g-3">
    <div class="col-12 col-xl-8">
      <div class="explorer">
        <!-- Header -->
        <div class="explorer-header">
          <div class="ribbon d-flex flex-wrap gap-2 align-items-center mb-2">
            <button class="btn btn-sm btn-outline-secondary" id="btnBack"><i class="bi bi-arrow-left"></i></button>
            <button class="btn btn-sm btn-outline-secondary" id="btnForward"><i class="bi bi-arrow-right"></i></button>
            <button class="btn btn-sm btn-outline-secondary" id="btnUp"><i class="bi bi-arrow-up"></i></button>
            <div class="vr mx-1"></div>
            <button class="btn btn-sm btn-outline-primary" id="btnProperties"><i class="bi bi-sliders"></i> Properties</button>
            <button class="btn btn-sm btn-outline-primary" id="btnShare"><i class="bi bi-share"></i> Share…</button>
            <button class="btn btn-sm btn-outline-primary" id="btnAdvShare"><i class="bi bi-gear"></i> Advanced Sharing…</button>
            <div class="vr mx-1 d-none d-sm-block"></div>
            <div class="ms-auto d-none d-md-flex align-items-center gap-2">
              <i class="bi bi-question-circle"></i><span class="text-muted small">Nhấp đúp (PC) / chạm (Mobile) để mở</span>
            </div>
          </div>
          <div class="address-bar" id="addressBar" role="navigation" aria-label="Address">
            <span class="crumb"><i class="bi bi-pc-display"></i> <strong>This PC</strong></span>
            <i class="bi bi-chevron-right"></i>
            <span class="crumb" id="crumbFolder">Documents</span>
          </div>
        </div>

        <!-- Mobile toolbar -->
        <div class="mobile-toolbar d-flex gap-2 p-2 d-sm-none">
          <button class="btn btn-outline-secondary btn-sm flex-fill" id="mbCtx"><i class="bi bi-three-dots-vertical"></i> Menu</button>
          <button class="btn btn-outline-primary btn-sm flex-fill" id="mbProperties"><i class="bi bi-sliders"></i> Properties</button>
          <button class="btn btn-outline-primary btn-sm flex-fill" id="mbShare"><i class="bi bi-share"></i> Share</button>
        </div>

        <div class="row g-0">
          <!-- Sidebar -->
          <div class="col-12 col-md-4 col-lg-3 sidebar">
            <div class="p-2">
              <div class="nav-item-fx active" data-nav="thispc">
                <i class="bi bi-pc-display"></i> <span>This PC</span>
              </div>
              <div class="nav-item-fx" data-nav="network">
                <i class="bi bi-diagram-3"></i> <span>Network</span>
              </div>
              <div class="nav-item-fx" data-nav="quick">
                <i class="bi bi-star"></i> <span>Quick Access</span>
              </div>
            </div>
            <hr class="my-2">
            <div class="px-2 pb-3">
              <div class="small text-muted">Thiết bị trong mạng</div>
              <div class="nav-item-fx" data-computer="MAY_1">
                <i class="bi bi-pc-display"></i> <span>MAY_1</span>
              </div>
              <div class="nav-item-fx" data-computer="MAY_2">
                <i class="bi bi-pc-display"></i> <span>MAY_2</span>
              </div>
            </div>
          </div>
          <!-- Content -->
          <div class="col-12 col-md-8 col-lg-9 content">
            <div class="p-3" id="contentArea">
              <!-- dynamic -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Steps & Feedback -->
    <div class="col-12 col-xl-4">
      <div class="card">
        <div class="card-header bg-white">
          <strong>Nhiệm vụ & Tiêu chí hoàn thành</strong>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center">
              <span><span class="badge text-bg-primary badge-step">Nhiệm vụ 2</span> Chia sẻ thư mục <strong>SÁCH LỚP 12</strong> trên <strong>MAY_1</strong></span>
              <span id="task2Status" class="badge text-bg-secondary">Chưa</span>
            </div>
            <ol class="mt-2 small" id="task2Checklist">
              <li data-k="openedProps">Mở <em>Properties</em> của thư mục</li>
              <li data-k="openedSharingTab">Chuyển sang thẻ <em>Sharing</em></li>
              <li data-k="addedEveryone">Thêm <code>Everyone</code> vào danh sách chia sẻ</li>
              <li data-k="setPermission">Chọn quyền <em>Read</em> hoặc <em>Read/Write</em></li>
              <li data-k="confirmedShare">Nhấn <em>Share</em> để xác nhận</li>
            </ol>
          </div>
          <hr>
          <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center">
              <span><span class="badge text-bg-success badge-step">Bước kế tiếp</span> Truy cập từ máy khác</span>
              <span id="taskViewStatus" class="badge text-bg-secondary">Chưa</span>
            </div>
            <p class="small mb-1">Mở <strong>Network → MAY_1</strong> và nhìn thấy thư mục đã chia sẻ.</p>
          </div>
          <hr>
          <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center">
              <span><span class="badge text-bg-danger badge-step">Nhiệm vụ 3</span> Hủy bỏ chia sẻ</span>
              <span id="task3Status" class="badge text-bg-secondary">Chưa</span>
            </div>
            <ol class="mt-2 small" id="task3Checklist">
              <li data-k="openAdv">Mở <em>Advanced Sharing…</em></li>
              <li data-k="uncheck">Bỏ dấu ✓ ở <em>Share this folder</em></li>
              <li data-k="applyOk">Nhấn <em>OK/Apply</em> để xác nhận</li>
            </ol>
          </div>
          <div class="alert alert-info small mb-0">
            <i class="bi bi-phone"></i> <strong>Mẹo trên di động:</strong> chạm vào thư mục để mở. Nhấn nút <span class="badge text-bg-secondary"><i class="bi bi-three-dots-vertical"></i></span> để mở menu (thay cho chuột phải). Giữ lâu (long-press) cũng được hỗ trợ.
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Context menu -->
<div class="ctx-menu shadow" id="ctxMenu" role="menu" aria-hidden="true">
  <div class="ctx-item" data-action="open"><i class="bi bi-folder2-open"></i> Open</div>
  <div class="ctx-item" data-action="properties"><i class="bi bi-sliders"></i> Properties</div>
  <div class="ctx-item" data-action="share"><i class="bi bi-share"></i> Share…</div>
  <div class="ctx-item" data-action="advshare"><i class="bi bi-gear"></i> Advanced Sharing…</div>
</div>

<!-- Properties Modal -->
<div class="modal fade" id="propsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-folder"></i> SÁCH LỚP 12 – Properties</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
      </div>
      <div class="modal-body">
        <ul class="nav nav-tabs" id="propsTabs" role="tablist">
          <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabGeneral" type="button" role="tab">General</button></li>
          <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabSharing" type="button" role="tab">Sharing</button></li>
          <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabSecurity" type="button" role="tab">Security</button></li>
          <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabPrev" type="button" role="tab">Previous Versions</button></li>
          <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabCustomize" type="button" role="tab">Customize</button></li>
        </ul>
        <div class="tab-content">
          <div class="tab-pane fade show active" id="tabGeneral" role="tabpanel">
            <div class="row g-3 align-items-center">
              <div class="col-auto">
                <i class="bi bi-folder-fill" style="font-size:3rem;color:#fbbc05"></i>
              </div>
              <div class="col">
                <div><strong>Name:</strong> SÁCH LỚP 12</div>
                <div><strong>Type:</strong> File folder</div>
                <div><strong>Location:</strong> C:\Users\Public\Documents</div>
                <div><strong>Size:</strong> 128 MB</div>
                <div><strong>Contains:</strong> 12 Files, 3 Folders</div>
                <div><strong>Created:</strong> 01/09/2025 08:15 AM</div>
              </div>
            </div>
            <hr>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="chkReadOnly">
              <label class="form-check-label" for="chkReadOnly">Read-only</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="chkHidden">
              <label class="form-check-label" for="chkHidden">Hidden</label>
            </div>
            <button class="btn btn-outline-secondary btn-sm mt-2" disabled>Advanced…</button>
          </div>
          <div class="tab-pane fade" id="tabSharing" role="tabpanel">
            <div class="mb-2"><strong>Network File and Folder Sharing</strong></div>
            <div id="shareStatus" class="alert alert-secondary py-2 small mb-2">Not shared</div>
            <div class="d-flex gap-2 mb-3">
              <button class="btn btn-primary btn-sm" id="openShareDialog"><i class="bi bi-share"></i> Share…</button>
              <button class="btn btn-outline-primary btn-sm" id="openAdvDialog"><i class="bi bi-gear"></i> Advanced Sharing…</button>
            </div>
            <div class="small text-muted">Password Protection: <em>Off in this simulation</em></div>
          </div>
          <div class="tab-pane fade" id="tabSecurity" role="tabpanel">
            <div class="text-muted">Security permissions are simplified in this simulation.</div>
          </div>
          <div class="tab-pane fade" id="tabPrev" role="tabpanel">
            <div class="text-muted">No previous versions available.</div>
          </div>
          <div class="tab-pane fade" id="tabCustomize" role="tabpanel">
            <div class="text-muted">Customize options are not simulated.</div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <span class="text-muted small me-auto">Mẹo: Chuyển qua thẻ <em>Sharing</em> để thiết lập chia sẻ.</span>
        <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button class="btn btn-primary" data-bs-dismiss="modal">OK</button>
      </div>
    </div>
  </div>
</div>

<!-- Share Modal -->
<div class="modal fade" id="shareModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-person-plus"></i> Choose people to share with</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
      </div>
      <div class="modal-body">
        <div class="row g-2 align-items-end">
          <div class="col-12 col-md-6">
            <label class="form-label">Người dùng</label>
            <select id="userSelect" class="form-select">
              <option value="user11">user11</option>
              <option value="user12">user12</option>
              <option value="Everyone" selected>Everyone</option>
            </select>
          </div>
          <div class="col-12 col-md-3">
            <label class="form-label">Quyền</label>
            <select id="permSelect" class="form-select">
              <option value="Read" selected>Read</option>
              <option value="Read/Write">Read/Write</option>
            </select>
          </div>
          <div class="col-12 col-md-3 d-grid">
            <button class="btn btn-primary" id="btnAddShare"><i class="bi bi-plus-circle"></i> Add</button>
          </div>
        </div>
        <div class="share-list mt-3">
          <table class="table table-sm align-middle">
            <thead>
            <tr><th>User</th><th>Permission Level</th><th class="text-end">Action</th></tr>
            </thead>
            <tbody id="shareListBody">
            <!-- rows -->
            </tbody>
          </table>
          <div class="small text-muted">Gợi ý: Bài này giới hạn chia sẻ cho <code>Everyone</code>.</div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="text-muted small me-auto" id="shareHint">Hãy thêm <code>Everyone</code>, chọn quyền rồi nhấn <strong>Share</strong>.</div>
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary" id="btnConfirmShare">Share</button>
      </div>
    </div>
  </div>
</div>

<!-- Advanced Sharing Modal -->
<div class="modal fade" id="advModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-md modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-gear"></i> Advanced Sharing</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
      </div>
      <div class="modal-body">
        <div class="form-check mb-3">
          <input class="form-check-input" type="checkbox" id="chkShareThisFolder">
          <label class="form-check-label" for="chkShareThisFolder">Share this folder</label>
        </div>
        <div class="mb-3">
          <label class="form-label">Share name</label>
          <input class="form-control" id="shareName" value="SÁCH LỚP 12">
        </div>
        <div class="small text-muted">Permissions & Caching… (đơn giản hóa trong mô phỏng)</div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-outline-primary" id="btnApplyAdv">Apply</button>
        <button class="btn btn-primary" id="btnOkAdv" data-bs-dismiss="modal">OK</button>
      </div>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index:11000">
  <div id="liveToast" class="toast align-items-center text-bg-primary border-0" role="status" aria-live="polite" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body" id="toastMsg">Đã cập nhật.</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
/* ---------- STATE ---------- */
const state = {
  currentView: "thispc",     // "thispc" | "network" | "computer:MAY_1"
  history: [],
  future: [],
  folderSelected: "SÁCH LỚP 12",
  shared: false,
  sharePermission: "Read",    // "Read" or "Read/Write"
  shareName: "SÁCH LỚP 12",
  checklist:{
    openedProps:false,
    openedSharingTab:false,
    addedEveryone:false,
    setPermission:false,
    confirmedShare:false,
    viewFromOther:false,
    advOpen:false,
    advUnchecked:false,
    advApplied:false
  }
};

/* ---------- HELPERS ---------- */
const $ = (sel, root=document) => root.querySelector(sel);
const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

function showToast(msg, type="primary"){
  const t = $("#liveToast");
  t.className = "toast align-items-center text-bg-"+type+" border-0";
  $("#toastMsg").textContent = msg;
  bootstrap.Toast.getOrCreateInstance(t, {delay:1500}).show();
}

function updateChecklist(){
  // Task 2 status
  const done2 = ["openedProps","openedSharingTab","addedEveryone","setPermission","confirmedShare"].every(k=>state.checklist[k]);
  $("#task2Status").className = "badge "+(done2?"text-bg-success":"text-bg-secondary");
  $("#task2Status").textContent = done2?"Xong":"Chưa";
  // Mark items
  $$("#task2Checklist li").forEach(li=>{
    const k = li.getAttribute("data-k");
    li.style.textDecoration = state.checklist[k] ? "line-through" : "none";
  });
  // View from other
  $("#taskViewStatus").className = "badge "+(state.checklist.viewFromOther?"text-bg-success":"text-bg-secondary");
  $("#taskViewStatus").textContent = state.checklist.viewFromOther?"Xong":"Chưa";
  // Task 3
  const done3 = ["advOpen","advUnchecked","advApplied"].every(k=>state.checklist[k]);
  $("#task3Status").className = "badge "+(done3?"text-bg-success":"text-bg-secondary");
  $("#task3Status").textContent = done3?"Xong":"Chưa";
  $$("#task3Checklist li").forEach(li=>{
    const k = li.getAttribute("data-k");
    li.style.textDecoration = state.checklist[k] ? "line-through" : "none";
  });
}

function setAddressBar(){
  const bar = $("#addressBar");
  bar.innerHTML = "";
  const home = document.createElement("span");
  home.className="crumb";
  home.innerHTML = `<i class="bi bi-pc-display"></i> <strong>${state.currentView.startsWith("computer")?"Network": "This PC"}</strong>`;
  bar.appendChild(home);
  const sep = document.createElement("i");
  sep.className="bi bi-chevron-right mx-1";
  // add tail based on current
  if(state.currentView==="thispc"){
    const c = document.createElement("span"); c.className="crumb";
    c.innerHTML = `Documents`;
    bar.appendChild(sep); bar.appendChild(c);
  }else if(state.currentView==="network"){
    const c = document.createElement("span"); c.className="crumb";
    c.innerHTML = `Network`;
    bar.appendChild(sep); bar.appendChild(c);
  }else if(state.currentView.startsWith("computer:")){
    const name = state.currentView.split(":")[1];
    bar.appendChild(sep.cloneNode());
    const net = document.createElement("span"); net.className="crumb"; net.innerHTML="Network";
    bar.appendChild(net);
    bar.appendChild(sep.cloneNode());
    const node = document.createElement("span"); node.className="crumb"; node.innerHTML = name;
    bar.appendChild(node);
  }
}

function render(){
  setAddressBar();
  const area = $("#contentArea");
  area.innerHTML = "";
  if(state.currentView==="thispc"){
    const grid = document.createElement("div");
    grid.className="grid";
    grid.appendChild(makeFolderTile("SÁCH LỚP 12", {shareBadge: state.shared}));
    grid.appendChild(makeFolderTile("Học kỳ 1", {}));
    grid.appendChild(makeFolderTile("Học kỳ 2", {}));
    area.appendChild(grid);
  }else if(state.currentView==="network"){
    const grid = document.createElement("div"); grid.className="grid";
    grid.appendChild(makeComputerTile("MAY_1"));
    grid.appendChild(makeComputerTile("MAY_2"));
    area.appendChild(grid);
  }else if(state.currentView.startsWith("computer:")){
    const name = state.currentView.split(":")[1];
    const h = document.createElement("h6");
    h.innerHTML = `<i class="bi bi-pc-display"></i> ${name}`;
    area.appendChild(h);
    const grid = document.createElement("div"); grid.className="grid";
    if(name==="MAY_1"){
      if(state.shared){
        grid.appendChild(makeFolderTile(state.shareName, {shareBadge:true, readOnly: state.sharePermission==="Read"}));
        // viewing from other machine counts if coming via Network->MAY_1
        state.checklist.viewFromOther = true;
        updateChecklist();
      }else{
        const empty = document.createElement("div");
        empty.className="alert alert-secondary";
        empty.innerHTML = `Chưa có thư mục chia sẻ nào trên ${name}.`;
        area.appendChild(empty);
      }
    }else{
      const empty = document.createElement("div");
      empty.className="alert alert-secondary";
      empty.innerHTML = `Không có thư mục chia sẻ công khai trên ${name}.`;
      area.appendChild(empty);
    }
    area.appendChild(grid);
  }
}

function makeFolderTile(name, opts={}){
  const tile = document.createElement("div");
  tile.className="tile";
  tile.setAttribute("data-type","folder");
  tile.setAttribute("data-name", name);
  tile.innerHTML = `
    <i class="bi bi-folder-fill folder-icon"></i>
    <div class="flex-grow-1">
      <div class="fw-semibold">${name}</div>
      <div class="text-muted small">${opts.readOnly? "Permission: Read" : (state.shared && name===state.shareName ? "Permission: "+state.sharePermission : "Folder")}</div>
    </div>
    <button class="btn btn-light btn-sm d-sm-none" aria-label="Menu" data-mobile-menu><i class="bi bi-three-dots-vertical"></i></button>
  `;
  if(opts.shareBadge){
    const b = document.createElement("div");
    b.className="overlay-share";
    b.innerHTML = `<i class="bi bi-hdd-network network-cable"></i>`;
    tile.appendChild(b);
  }
  // events
  tile.addEventListener("dblclick", ()=> openFolder(name));
  tile.addEventListener("click", (e)=>{
    selectTile(tile);
    // on mobile, single tap opens
    if(window.matchMedia("(max-width: 576px)").matches){
      openFolder(name);
    }
  });
  // context menu (right-click)
  tile.addEventListener("contextmenu", (e)=>{
    e.preventDefault(); selectTile(tile);
    openCtxMenu(e.clientX, e.clientY, name);
  });
  // long press for mobile
  let pressTimer;
  tile.addEventListener("touchstart", (e)=>{
    pressTimer = setTimeout(()=>{
      const t = e.touches[0];
      openCtxMenu(t.clientX, t.clientY, name);
    }, 550);
  }, {passive:true});
  tile.addEventListener("touchend", ()=> clearTimeout(pressTimer));
  // mobile inline menu button
  tile.querySelector("[data-mobile-menu]")?.addEventListener("click",(e)=>{
    e.stopPropagation();
    const rect = e.currentTarget.getBoundingClientRect();
    openCtxMenu(rect.left, rect.bottom+6, name);
  });
  return tile;
}

function makeComputerTile(name){
  const tile = document.createElement("div");
  tile.className="tile";
  tile.setAttribute("data-type","computer");
  tile.innerHTML = `
    <i class="bi bi-pc-display computer-icon"></i>
    <div class="flex-grow-1">
      <div class="fw-semibold">${name}</div>
      <div class="text-muted small">Double-click/tap to view shares</div>
    </div>`;
  tile.addEventListener("dblclick", ()=> openComputer(name));
  tile.addEventListener("click", ()=>{
    if(window.matchMedia("(max-width: 576px)").matches){
      openComputer(name);
    }
  });
  return tile;
}

function selectTile(tile){
  $$(".tile").forEach(t=> t.classList.remove("selected"));
  tile.classList.add("selected");
}

function openFolder(name){
  // Only simulate opening if it is the special folder; others just show toast
  if(state.currentView==="thispc" && name==="SÁCH LỚP 12"){
    showToast("Mẹo: mở Properties để thiết lập chia sẻ.", "secondary");
  }else{
    showToast("Mở: "+name, "secondary");
  }
}

function openComputer(name){
  pushHistory();
  state.currentView = "computer:"+name;
  $("#crumbFolder").textContent = name;
  render();
}

/* ---------- CONTEXT MENU ---------- */
const ctxMenu = $("#ctxMenu");
let ctxTargetName = null;
function openCtxMenu(x,y,name){
  ctxTargetName = name;
  ctxMenu.style.left = x+"px";
  ctxMenu.style.top = y+"px";
  ctxMenu.style.display = "block";
}
function closeCtxMenu(){ ctxMenu.style.display="none"; }
document.addEventListener("click", (e)=>{
  if(!ctxMenu.contains(e.target)) closeCtxMenu();
});
$("#ctxMenu [data-action='properties']").addEventListener("click", ()=>{
  closeCtxMenu();
  openPropertiesTab("General");
});
$("#ctxMenu [data-action='share']").addEventListener("click", ()=>{
  closeCtxMenu();
  openPropertiesTab("Sharing", true);
});
$("#ctxMenu [data-action='advshare']").addEventListener("click", ()=>{
  closeCtxMenu();
  openAdvancedSharing();
});
$("#ctxMenu [data-action='open']").addEventListener("click", ()=>{
  closeCtxMenu();
  openFolder(ctxTargetName);
});

/* ---------- MODALS ---------- */
const propsModal = new bootstrap.Modal("#propsModal");
const shareModal = new bootstrap.Modal("#shareModal");
const advModal = new bootstrap.Modal("#advModal");

function openPropertiesTab(tab="General", viaContext=false){
  propsModal.show();
  // mark checklist
  state.checklist.openedProps = true;
  if(tab==="Sharing"){ state.checklist.openedSharingTab = true; }
  updateChecklist();
  setTimeout(()=>{
    if(tab==="Sharing"){
      const btn = $$(`#propsTabs .nav-link`).find(b=> b.dataset.bsTarget==="#tabSharing");
      btn?.click();
    }else{
      const btn = $$(`#propsTabs .nav-link`).find(b=> b.dataset.bsTarget==="#tabGeneral");
      btn?.click();
    }
    updateShareStatusInProps();
  }, 50);
}

function updateShareStatusInProps(){
  const st = $("#shareStatus");
  if(state.shared){
    st.className="alert alert-success py-2 small mb-2";
    st.innerHTML = `Shared as \\\\MAY_1\\${state.shareName} — Permission: <strong>${state.sharePermission}</strong>`;
  }else{
    st.className="alert alert-secondary py-2 small mb-2";
    st.textContent = "Not shared";
  }
}

/* Share dialog logic */
const shareListBody = $("#shareListBody");
function renderShareList(){
  shareListBody.innerHTML = "";
  const rows = [];
  if(state.shared){
    rows.push({user:"Everyone", perm: state.sharePermission});
  }
  rows.forEach(addShareRow);
}
function addShareRow(row){
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td>${row.user}</td>
    <td>${row.perm}</td>
    <td class="text-end"><button class="btn btn-sm btn-outline-danger" data-remove="${row.user}"><i class="bi bi-x"></i> Remove</button></td>
  `;
  shareListBody.appendChild(tr);
  tr.querySelector("[data-remove]")?.addEventListener("click", ()=>{
    if(row.user==="Everyone"){
      state.shared=false;
      showToast("Đã xoá Everyone khỏi danh sách chia sẻ","secondary");
      updateShareStatusInProps();
      render();
      updateChecklist(); // not changing checks here
      renderShareList();
    }else{
      tr.remove();
    }
  });
}

$("#openShareDialog").addEventListener("click", ()=>{
  state.checklist.openedSharingTab = true;
  updateChecklist();
  renderShareList();
  $("#userSelect").value = "Everyone";
  $("#permSelect").value = "Read";
  shareModal.show();
});
$("#openAdvDialog").addEventListener("click", ()=>{
  openAdvancedSharing();
});
$("#btnAddShare").addEventListener("click", ()=>{
  const user = $("#userSelect").value;
  const perm = $("#permSelect").value;
  if(user!=="Everyone"){
    showToast("Bài này chỉ chấm khi bạn thêm Everyone.","secondary");
  }else{
    state.checklist.addedEveryone = true;
    state.checklist.setPermission = true; // vì đã chọn ở dropdown
    // tạm thêm hiển thị danh sách (trước khi Share)
    shareListBody.innerHTML = `
      <tr><td>Everyone</td><td>${perm}</td><td class="text-end">
        <button class="btn btn-sm btn-outline-danger" disabled><i class="bi bi-x"></i> Remove</button>
      </td></tr>
    `;
  }
  updateChecklist();
});
$("#btnConfirmShare").addEventListener("click", ()=>{
  // commit share
  const perm = $("#permSelect").value;
  state.shared = true;
  state.sharePermission = perm;
  state.checklist.confirmedShare = true;
  updateChecklist();
  shareModal.hide();
  updateShareStatusInProps();
  render();
  showToast(`Đã chia sẻ "${state.shareName}" cho Everyone (${perm}).`,"primary");
});

/* Advanced sharing */
function openAdvancedSharing(){
  state.checklist.advOpen = true;
  $("#chkShareThisFolder").checked = state.shared;
  $("#shareName").value = state.shareName;
  advModal.show(); updateChecklist();
}
$("#btnApplyAdv").addEventListener("click", ()=>{
  const willShare = $("#chkShareThisFolder").checked;
  const newName = $("#shareName").value.trim() || "SÁCH LỚP 12";
  state.shareName = newName;
  if(!willShare){
    if(state.shared){ state.checklist.advUnchecked = true; }
    state.shared = false;
    state.checklist.advApplied = true;
    showToast("Đã hủy chia sẻ thư mục.","danger");
  }else{
    state.shared = true;
    // giữ nguyên permission hiện tại
    showToast("Đã áp dụng chia sẻ nâng cao.","primary");
  }
  updateChecklist();
  updateShareStatusInProps();
  render();
});
$("#btnOkAdv").addEventListener("click", ()=>{
  // same as apply then close
  $("#btnApplyAdv").click();
});

/* ---------- NAV ---------- */
function pushHistory(){
  state.history.push(state.currentView);
  state.future = [];
}
$("#btnBack").addEventListener("click", ()=>{
  if(state.history.length){
    state.future.push(state.currentView);
    state.currentView = state.history.pop();
    render();
  }
});
$("#btnForward").addEventListener("click", ()=>{
  if(state.future.length){
    state.history.push(state.currentView);
    state.currentView = state.future.pop();
    render();
  }
});
$("#btnUp").addEventListener("click", ()=>{
  if(state.currentView.startsWith("computer:")){
    state.currentView = "network";
    render();
  }else{
    // from "thispc" do nothing
  }
});
$$(".sidebar [data-nav]").forEach(el=>{
  el.addEventListener("click", ()=>{
    $$(".sidebar .nav-item-fx").forEach(n=> n.classList.remove("active"));
    el.classList.add("active");
    pushHistory();
    state.currentView = el.getAttribute("data-nav");
    render();
  });
});
$$(".sidebar [data-computer]").forEach(el=>{
  el.addEventListener("click", ()=>{
    $$(".sidebar .nav-item-fx").forEach(n=> n.classList.remove("active"));
    el.classList.add("active");
    openComputer(el.getAttribute("data-computer"));
  });
});

/* Ribbon buttons */
$("#btnProperties").addEventListener("click", ()=> openPropertiesTab("General"));
$("#btnShare").addEventListener("click", ()=> openPropertiesTab("Sharing", true));
$("#btnAdvShare").addEventListener("click", ()=> openAdvancedSharing());

/* Mobile toolbar mirror */
$("#mbCtx").addEventListener("click", (e)=>{
  // open context for target folder
  const first = $(`.tile[data-type="folder"][data-name="${state.folderSelected}"]`) || $(".tile[data-type='folder']");
  if(first){
    const rect = e.currentTarget.getBoundingClientRect();
    openCtxMenu(rect.left, rect.bottom+6, first.getAttribute("data-name"));
  }
});
$("#mbProperties").addEventListener("click", ()=> openPropertiesTab("General"));
$("#mbShare").addEventListener("click", ()=> openPropertiesTab("Sharing", true));

/* Dismiss ctx menu on escape / resize */
document.addEventListener("keydown",(e)=>{ if(e.key==="Escape") closeCtxMenu(); });
window.addEventListener("resize", closeCtxMenu);

/* ---------- INIT ---------- */
render(); updateChecklist();
</script>
</body>
</html>
